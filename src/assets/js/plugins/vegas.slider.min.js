!function (b) {
  "use strict";

  var defaults = {
    slide: 0,
    delay: 5000,
    loop: true,
    preload: false,
    preloadImage: false,
    preloadVideo: false,
    timer: true,
    overlay: false,
    autoplay: true,
    shuffle: false,
    cover: true,
    color: null,
    align: "center",
    valign: "center",
    firstTransition: null,
    firstTransitionDuration: null,
    transition: "fade",
    transitionDuration: 1000,
    transitionRegister: [],
    animation: null,
    animationDuration: "auto",
    animationRegister: [],
    slidesToKeep: 1,
    init: function () {},
    play: function () {},
    pause: function () {},
    walk: function () {},
    slides: []
  };

  var videoCache = {};

  var Vegas = function (el, options) {
    this.elmt = el;
    this.settings = b.extend({}, defaults, b.vegas.defaults, options);
    this.slide = this.settings.slide;
    this.total = this.settings.slides.length;
    this.noshow = this.total < 2;
    this.paused = !this.settings.autoplay || this.noshow;
    this.ended = false;

    this.$elmt = b(el);
    this.$timer = null;
    this.$overlay = null;
    this.$slide = null;
    this.timeout = null;
    this.first = true;

    this.transitions = [
      "fade","fade2","blur","blur2","flash","flash2",
      "negative","negative2","burn","burn2",
      "slideLeft","slideLeft2","slideRight","slideRight2",
      "slideUp","slideUp2","slideDown","slideDown2",
      "zoomIn","zoomIn2","zoomOut","zoomOut2",
      "swirlLeft","swirlLeft2","swirlRight","swirlRight2"
    ];

    this.animations = [
      "kenburns","kenburnsLeft","kenburnsRight",
      "kenburnsUp","kenburnsUpLeft","kenburnsUpRight",
      "kenburnsDown","kenburnsDownLeft","kenburnsDownRight"
    ];

    if (!(this.settings.transitionRegister instanceof Array)) {
      this.settings.transitionRegister = [this.settings.transitionRegister];
    }

    if (!(this.settings.animationRegister instanceof Array)) {
      this.settings.animationRegister = [this.settings.animationRegister];
    }

    this.transitions = this.transitions.concat(this.settings.transitionRegister);
    this.animations = this.animations.concat(this.settings.animationRegister);

    this.support = {
      objectFit: "objectFit" in document.body.style,
      transition:
        "transition" in document.body.style ||
        "WebkitTransition" in document.body.style,
      video: b.vegas.isVideoCompatible()
    };

    if (this.settings.shuffle === true) this.shuffle();

    this._init();
  };

  Vegas.prototype = {

    _init: function () {
      var self = this;
      var isBody = this.elmt.tagName === "BODY";
      var showTimer = this.settings.timer;
      var overlay = this.settings.overlay;

      this._preload();

      if (!isBody) {
        this.$elmt.css("height", this.$elmt.css("height"));
        var wrapper = b('<div class="vegas-wrapper">')
          .css("overflow", this.$elmt.css("overflow"))
          .css("padding", this.$elmt.css("padding"));

        if (!this.$elmt.css("padding")) {
          wrapper
            .css("padding-top", this.$elmt.css("padding-top"))
            .css("padding-bottom", this.$elmt.css("padding-bottom"))
            .css("padding-left", this.$elmt.css("padding-left"))
            .css("padding-right", this.$elmt.css("padding-right"));
        }

        this.$elmt.clone(true).children().appendTo(wrapper);
        this.elmt.innerHTML = "";
      }

      if (showTimer && this.support.transition) {
        var $timer = b('<div class="vegas-timer"><div class="vegas-timer-progress">');
        this.$timer = $timer;
        this.$elmt.prepend($timer);
      }

      if (overlay) {
        var $overlay = b('<div class="vegas-overlay">');
        if (typeof overlay === "string") {
          $overlay.css("background-image", "url(" + overlay + ")");
        }
        this.$overlay = $overlay;
        this.$elmt.prepend($overlay);
      }

      this.$elmt.addClass("vegas-container");

      if (!isBody) this.$elmt.append(wrapper);

      setTimeout(function () {
        self.trigger("init");
        self._goto(self.slide);
        if (self.settings.autoplay) self.trigger("play");
      }, 1);
    },

    _preload: function () {
      for (var i = 0; i < this.settings.slides.length; i++) {
        var slide = this.settings.slides[i];

        if ((this.settings.preload || this.settings.preloadImages) && slide.src) {
          new Image().src = slide.src;
        }

        if ((this.settings.preload || this.settings.preloadVideos) &&
            this.support.video &&
            slide.video) {
          if (slide.video instanceof Array) {
            this._video(slide.video);
          } else {
            this._video(slide.video.src);
          }
        }
      }
    },

    _video: function (sourceArray) {
      var key = sourceArray.toString();
      if (videoCache[key]) return videoCache[key];

      if (!(sourceArray instanceof Array)) sourceArray = [sourceArray];

      var video = document.createElement("video");
      video.preload = true;

      sourceArray.forEach(function (src) {
        var s = document.createElement("source");
        s.src = src;
        video.appendChild(s);
      });

      videoCache[key] = video;
      return video;
    },

    shuffle: function () {
      for (var i = this.total - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = this.settings.slides[i];
        this.settings.slides[i] = this.settings.slides[j];
        this.settings.slides[j] = temp;
      }
    },

    play: function () {
      if (this.paused) {
        this.paused = false;
        this.next();
        this.trigger("play");
      }
    },

    pause: function () {
      this._timer(false);
      this.paused = true;
      this.trigger("pause");
    },

    next: function () {
      this.slide++;
      if (this.slide >= this.total) {
        if (!this.settings.loop) return this._end();
        this.slide = 0;
      }
      this._goto(this.slide);
    },

    previous: function () {
      this.slide--;
      if (this.slide < 0) {
        if (!this.settings.loop) return this.slide++;
        this.slide = this.total - 1;
      }
      this._goto(this.slide);
    },

    destroy: function () {
      clearTimeout(this.timeout);
      this.$elmt.removeClass("vegas-container");
      this.$elmt.find("> .vegas-slide").remove();
      this.$elmt.find("> .vegas-wrapper").clone(true).children().appendTo(this.$elmt);
      this.$elmt.find("> .vegas-wrapper").remove();
      if (this.settings.timer) this.$timer.remove();
      if (this.settings.overlay) this.$overlay.remove();
      this.elmt._vegas = null;
    }
  };

  // jQuery Plugin wrapper
  b.fn.vegas = function (options) {
    var returnVal;
    var args = arguments;
    var error = false;

    if (!options || typeof options === "object") {
      return this.each(function () {
        if (!this._vegas) this._vegas = new Vegas(this, options);
      });
    }

    if (typeof options === "string") {
      this.each(function () {
        var instance = this._vegas;
        if (!instance) throw new Error("No Vegas applied.");
        if (typeof instance[options] === "function" && options[0] !== "_") {
          returnVal = instance[options].apply(instance, [].slice.call(args, 1));
        } else {
          error = true;
        }
      });

      if (error) throw new Error('No method "' + options + '" in Vegas.');

      return returnVal !== undefined ? returnVal : this;
    }
  };

  b.vegas = {};
  b.vegas.defaults = defaults;
  b.vegas.isVideoCompatible = function () {
    return !/(Android|webOS|Phone|iPad|iPod|BlackBerry|Windows Phone)/i.test(
      navigator.userAgent
    );
  };

}(window.jQuery || window.Zepto);
